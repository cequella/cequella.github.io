import { Sketch, SketchMetadata } from './types';

export class FractalTreeSketch implements Sketch {
    readonly metadata: SketchMetadata = {
        id: 'fractal-tree',
        title: {
            pt: 'Flores Recursivas',
            en: 'Recursive Blooms'
        },
        description: {
            pt: 'Padrões geométricos emergindo de regras recursivas simples, criando estruturas arquitetônicas complexas.',
            en: 'Geometric patterns emerging from simple recursive rules, creating complex architectural structures.'
        },
        image: '/fractal-tree.png'
    };

    private ctx: CanvasRenderingContext2D | null = null;
    private width = 0;
    private height = 0;
    private animationId = 0;
    private time = 0;

    setup(canvas: HTMLCanvasElement) {
        this.ctx = canvas.getContext('2d');
        this.resize(canvas.width, canvas.height);
        this.animate();
    }

    resize(w: number, h: number) {
        this.width = w;
        this.height = h;
    }

    animate = () => {
        if (!this.ctx) return;

        this.time += 0.01;

        // Dark background with a hint of texture
        this.ctx.fillStyle = '#0d0d0d';
        this.ctx.fillRect(0, 0, this.width, this.height);

        this.ctx.save();
        this.ctx.translate(this.width / 2, this.height * 0.9);

        // Multi-layered movement for natural feel
        const baseAngle = Math.sin(this.time * 0.5) * 0.4 + 0.45;
        const wiggle = Math.sin(this.time * 2) * 0.02;

        this.drawBranch(this.height * 0.25, baseAngle + wiggle, 0);
        this.ctx.restore();

        this.animationId = requestAnimationFrame(this.animate);
    }

    drawBranch(len: number, angle: number, depth: number) {
        if (!this.ctx) return;

        // Constructivist Palette Rotation
        // Deep Red -> Bright Red -> Aged White
        let color = '#cc2222'; // Default red
        if (depth > 4) color = '#ff3333';
        if (depth > 7) color = '#e6e2d3'; // Aged Paper White

        this.ctx.strokeStyle = color;
        this.ctx.lineWidth = Math.max(1, 12 - depth * 1.2);

        // Subtle glow for "Premium" feel
        if (depth > 6) {
            this.ctx.shadowBlur = 10;
            this.ctx.shadowColor = color;
        } else {
            this.ctx.shadowBlur = 0;
        }

        this.ctx.beginPath();
        this.ctx.moveTo(0, 0);
        this.ctx.lineTo(0, -len);
        this.ctx.stroke();

        this.ctx.translate(0, -len);

        if (depth < 10) {
            const nextLen = len * 0.75;

            // Right branch
            this.ctx.save();
            this.ctx.rotate(angle);
            this.drawBranch(nextLen, angle, depth + 1);
            this.ctx.restore();

            // Left branch
            this.ctx.save();
            this.ctx.rotate(-angle * 0.8); // Slight asymmetry for natural look
            this.drawBranch(nextLen, angle, depth + 1);
            this.ctx.restore();
        }
    }

    destroy() {
        cancelAnimationFrame(this.animationId);
    }
}
